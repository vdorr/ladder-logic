<html>
<head>

<meta name="robots" content="noindex">
<meta charset="utf-8"/>

	<script type="text/javascript">

// ----------------------------- !!! -------------------------------------------
	env = null;
// ----------------------------- !!! -------------------------------------------

class Environment {
	constructor(logger) {
		this.out = logger
		this.m = {};
		this.states = [];
		this.running = false; //FIXME remove
		this.tmr = null;
		this.scan_count = 0;
	}
	run() { //FIXME remove
		return this.running;
	}
	get(name) {
// 		console.log("1");
		return this.m[name];
	}
	set(name, value) {
		this.m[name] = value;
// 		console.log("2");
	}
	scan_begin() {
	}
	scan_end() {
//TODO copy values from outs to ins
// 		console.log("scan_end");
		this.out("scan nr. " + this.scan_count + " ----------------\n");
		this.scan_count += 1;
		for (var v in this.states) {
			const name = this.states[v];
			const value = this.m["out " + name];
			this.m["in " + name] = value;

			this.out(name + ": " + value + "\n");//sad!!!
		}
	}
	add_st(name, value) {
		this.states.push(name);
		this.m["in " + name] = value;
		this.m["out " + name] = value;
		console.log(["add_st: ", this.states]);
	}
	add_tmp(name, value) {
		this.m[name] = value;
	}
	start (period) {
		this.scan_count = 0;
		console.log(["start", period, this.body]);
		this.tmr = setInterval(this.body, period)
	}
	stop () {
		console.log(["stop"]);
		clearInterval(this.tmr);
	}
}

// -----------------------------------------------------------------------------

function run_checkbox() {
	if ( null == env ) {
		return;
	}
	var chk_run = document.getElementById("id_sim_run");
	var txt_period = document.getElementById("id_sim_period");
	const period = parseInt(txt_period.value);

	if ( chk_run.checked && period != NaN ) {
// 		clear_output();
		env.start(period);
	} else {
		chk_run.checked = false;
		env.stop();
	}
}

function compile() {

	const src = document.getElementById("tasrc").value;
	const escaped_src = encodeURIComponent(src);

	const compiler_address = document.getElementById("id_compiler_address").value;
// 	const compiler_address = "localhost:3000";
// 	const compiler_address = "excellentlizard.herokuapp.com";

	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://" + compiler_address + "/compile?src=" + escaped_src, true);

	xhr.onload = function () {

		var rsp = JSON.parse(this.responseText);
        console.log(rsp.failure);
        if ( rsp.failure != null || null == rsp.artifact ) {
			output_line("compilation failed :-(\n");
			output_line("error response:\n");
			output_line(rsp.failure + "\n");
        } else {
			output_line("compiled, got " + rsp.artifact.length + " bytes of javascript\n");
        }

		if ( null != env ) {
			env.stop();
			env = null;
		}
        const p = eval(rsp.artifact)
		console.log(p);
		if ( typeof p === "function" ) {
			env = new Environment(output_line);
			console.log("invoking");
			p(env);
			console.log("done");
		}

	};

	xhr.onerror = function () {
		output_line("failed to invoke compiler (" + xhr.status +")\n");
	};

	clear_output();
	output_line("invoking compiler at " + compiler_address + "\n");

	console.log("sending");
	xhr.send();

}

function output_line(s) {
	var textarea = document.getElementById("id_output");
	textarea.value += s;
	textarea.scrollTop = textarea.scrollHeight;
}

function clear_output() {
	document.getElementById("id_output").value = "";
}

function load_example() {
	document.getElementById("tasrc").value
		= document.getElementById("id_examples").value;
}

function loaded() {
	document.getElementById("id_examples").selectedIndex = 1;
	load_example();
}

// -----------------------------------------------------------------------------

    </script>
</head>
<body onload="loaded();">

<select id="id_compiler_address">
<option value="localhost:3000">localhost:3000</option>
<option value="excellentlizard.herokuapp.com">excellentlizard.herokuapp.com</option>
</select>

<button onclick="compile();">compile</button>
<input type="checkbox" id="id_sim_run" value="" onclick="run_checkbox();">run</input>
<input type="text" id="id_sim_period" value="500">ms
<button onclick="clear_output();">clear output</button>

<div>

	<textarea style="margin: 0; float: left;" rows="32" cols="64" id="tasrc"></textarea>

	<textarea style="margin: 0; float: left;" rows="32" cols="64" id="id_output"></textarea>

	<table style="margin: 0; float: left;" id="id_stuff">
		<tr> <td>0</td> <td> <input type="text" id="" value="0"> </td> </tr>
		<tr> <td>1</td> <td> <input type="text" id="" value="0"> </td> </tr>
	</table>

</div>

examples:
<select id="id_examples" onchange="load_example();">
<option value="">empty</option>
<option value=
"(* --- test 04 --- *)

| %MX0  %MX1        %MX1
+--[/]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[/]---[ ]---(S)---(R)-
| %MX0  %MX1        %MX1
+--[ ]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[ ]---[ ]---(R)---(R)-
|
">two bit counter</option>
</select>

</body>
