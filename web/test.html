<html>
<head>
<meta charset="utf-8"/>
	<script type="text/javascript">

// ----------------------------- !!! -------------------------------------------
	env = null;
// ----------------------------- !!! -------------------------------------------

class Environment {
	constructor() {
		this.m = {};
		this.states = [];
		this.running = false; //FIXME remove
		this.tmr = null;
	}
	run() {  //FIXME remove
		return this.running;
	}
	get(name) {
// 		console.log("1");
		return this.m[name];
	}
	set(name, value) {
		this.m[name] = value;
// 		console.log("2");
	}
	scan_begin() {
//TODO copy values from ins to outs
		console.log("3");
	}
	scan_end() {
//TODO copy values from outs to ins
		console.log("4");
	}
	add_st(name, value) {
		this.states.push(name);
		this.m["in " + name] = value;
		this.m["out " + name] = value;
		console.log("5 " + name);
	}
	add_tmp(name, value) {
		this.m[name] = value;
		//console.log("6 " + name);
	}
	start (period) {
		console.log(["start", period, this.body]);
		this.tmr = setInterval(this.body, period)
	}
	stop () {
		console.log(["stop"]);
		clearInterval(this.tmr);
	}
}

// -----------------------------------------------------------------------------

function run_checkbox() {
	if ( null == env ) {
		return;
	}
	var chk_run = document.getElementById("id_sim_run");
	var txt_period = document.getElementById("id_sim_period");
	const period = parseInt(txt_period.value);

	if ( chk_run.checked && period != NaN ) {
		env.start(period);
	} else {
		chk_run.checked = false;
		env.stop();
	}
}

function compile() {
	const src = document.getElementById("tasrc").value;
	const escaped_src = encodeURIComponent(src);
	console.log(escaped_src);

	var xhr = new XMLHttpRequest();
	xhr.open('GET', 'http://localhost:3000/compile?src=' + escaped_src, true);
// 	xhr.open('GET', 'http://excellentlizard.herokuapp.com/compile?src=' + escaped_src, true);

	xhr.onload = function () {
	// Request finished. Do processing here.
		console.log("done");
        var rsp = JSON.parse(this.responseText);
        console.log(rsp.failure);
        console.log(rsp.artifact);

//just test it, store it somewhere... later
		if ( null != env ) {
			env.stop();
			env = null;
		}
        const p = eval(rsp.artifact)
		console.log(p);
		if ( typeof p === "function" ) {
			env = new Environment();
			console.log("invoking");
			p(env);
			console.log("done");
		}

	};

	console.log("sending");
	xhr.send();

}

// -----------------------------------------------------------------------------

    </script>
</head>
<body>
    <div>

<textarea rows="24" cols="48" id="tasrc">
(* --- test 04 --- *)

| %MX0  %MX1        %MX1
+--[/]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[/]---[ ]---(S)---(R)-
| %MX0  %MX1        %MX1
+--[ ]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[ ]---[ ]---(R)---(R)-
|
</textarea>

<textarea rows="24" cols="48" id="response">
</textarea>
    </div>

<button onclick="compile();">compile</button>
<input type="checkbox" id="id_sim_run" value="" onclick="run_checkbox();">run</input>
<input type="text" id="id_sim_period" value="500">ms

</body>
