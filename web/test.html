<html>
<head>

<meta name="robots" content="noindex">
<meta charset="utf-8"/>

	<script type="text/javascript">

// ----------------------------- !!! -------------------------------------------
	env = null;
// ----------------------------- !!! -------------------------------------------

class Environment {
	constructor(view) {
		view.set_env(this);
		this.view = view;
		this.out = view.logger
		this.m = {};
		this.states = [];
		this.user_forced = {};
		this.tmr = null;
		this.scan_count = 0;
		this.view.new_env();
	}
	get(name) {
		return this.m[name];
	}
	set(name, value) {
		this.m[name] = value;
	}
	scan_begin() {
		for (var name in this.user_forced) {
			const new_val = this.user_forced[name];
			this.m["in " + name] = new_val;
			this.m["out " + name] = new_val;
			console.log(name + " forced " + new_val);
		}
		this.user_forced = {};
	}
	set_user_state(name, new_val) {
		this.user_forced[name] = new_val && true;
	}
	scan_end() {
		this.view.scan_end(this);
		this.scan_count += 1;
		for (var v in this.states) {
			const name = this.states[v];
			const value = this.m["out " + name];
			this.m["in " + name] = value;
			this.view.set_st(name, value);
		}
	}
	add_st(name, value) {
		this.view.add_st(name, value);
		this.states.push(name);
		this.m["in " + name] = value;
		this.m["out " + name] = value;
		console.log(["add_st: ", this.states]);
	}
	add_tmp(name, value) {
		this.m[name] = value;
	}
	start (period) {
// 		this.scan_count = 0;
		console.log(["start", period, this.body]);
		this.tmr = setInterval(this.body, period)
	}
	stop () {
		console.log(["stop"]);
		clearInterval(this.tmr);
	}
}

// -----------------------------------------------------------------------------

class SimWindow {
	constructor() {
		this.state_tab = {};

		this.logger = output_line;
		this.chk_run = document.getElementById("id_sim_run");
		this.txt_period = document.getElementById("id_sim_period");
		this.ta_out = document.getElementById("id_output");
		this.ta_src = document.getElementById("tasrc");
		this.cbo_ex = document.getElementById("id_examples");
		this.tbl_state = document.getElementById("id_states");

		this.cbo_ex.selectedIndex = 1;
	}
	set_env(env) { //callled by newly created env
		this.env = env;
	}
	new_env() {
		this.state_tab = {};
		this.tbl_state.innerHTML = "";
	}
	add_st(name, value) {
		var row = this.tbl_state.insertRow(0);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		cell1.innerHTML = name;
		
		var input = document.createElement("input");
		input.type = "text";
		input.value = value;
		cell2.appendChild(input);
		var target = this;
		input.onchange = function () { target.user_st_change(name, input.value); };

		this.state_tab[name] = input;
	}
	user_st_change(state, new_val) {
		console.log(state + " eeek " + new_val);
		this.env.set_user_state(state, new_val);
	}
	scan_end(view) {
 		this.out("scan number " + view.scan_count + " ----------------\n");
	}
	set_st(name, value) {
 		this.out(name + ": " + value + "\n");
		this.state_tab[name].value = value;
	}
	out(s) {
		this.ta_out.value += s;
		this.ta_out.scrollTop = this.ta_out.scrollHeight;
	}
};

// -----------------------------------------------------------------------------

function run_checkbox() {
	if ( null == env ) {
		return;
	}
	var chk_run = document.getElementById("id_sim_run");
	var txt_period = document.getElementById("id_sim_period");
	const period = parseInt(txt_period.value);

	if ( chk_run.checked && period != NaN ) {
// 		clear_output();
		env.start(period);
	} else {
		chk_run.checked = false;
		env.stop();
	}
}

// -----------------------------------------------------------------------------

function compile() {

	const src = document.getElementById("tasrc").value;
	const escaped_src = encodeURIComponent(src);

	const compiler_address = document.getElementById("id_compiler_address").value;
// 	const compiler_address = "localhost:3000";
// 	const compiler_address = "excellentlizard.herokuapp.com";

	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://" + compiler_address + "/compile?src=" + escaped_src, true);

	xhr.onload = function () {

		var rsp = JSON.parse(this.responseText);
        console.log(rsp.failure);
        if ( rsp.failure != null || null == rsp.artifact ) {
			output_line("compilation failed :-(\n");
			output_line("error response:\n");
			output_line(rsp.failure + "\n");
        } else {
			output_line("compiled, got " + rsp.artifact.length + " bytes of javascript\n");
        }

		if ( null != env ) {
			env.stop();
			env = null;
		}
        const p = eval(rsp.artifact)
		console.log(p);
		if ( typeof p === "function" ) {
			env = new Environment(sw);
			console.log("invoking");
			p(env);
			console.log("done");
		}
	};

	xhr.onerror = function () {
		output_line("failed to invoke compiler (" + xhr.status +")\n");
	};

	clear_output();
	output_line("invoking compiler at " + compiler_address + "\n");

	console.log("sending");
	xhr.send();

}

// -----------------------------------------------------------------------------

function output_line(s) {
	var textarea = document.getElementById("id_output");
	textarea.value += s;
	textarea.scrollTop = textarea.scrollHeight;
}

function clear_output() {
	document.getElementById("id_output").value = "";
}

function load_example() {
	document.getElementById("tasrc").value
		= document.getElementById("id_examples").value;
}

function loaded() {
	sw = new SimWindow();

	document.getElementById("id_examples").selectedIndex = 1;
	load_example();
}

// -----------------------------------------------------------------------------

    </script>

</head>
<body onload="loaded();">

<select id="id_compiler_address">
<option value="localhost:3000">localhost:3000</option>
<option value="excellentlizard.herokuapp.com">excellentlizard.herokuapp.com</option>
</select>

<button onclick="compile();">compile</button>
<input type="checkbox" id="id_sim_run" value="" onclick="run_checkbox();">run</input>
<input type="text" id="id_sim_period" value="500">ms
<button onclick="clear_output();">clear output</button>

<div>
	<textarea style="margin: 0; float: left;" rows="32" cols="64" id="tasrc"></textarea>
	<textarea style="margin: 0; float: left;" rows="32" cols="64" id="id_output"></textarea>
	<table style="margin: 0; float: left;" id="id_states">
	</table>
</div>

examples:
<select id="id_examples" onchange="load_example();">
<option value="">empty</option>
<option value=
"(* --- test 04 --- *)

| %MX0  %MX1        %MX1
+--[/]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[/]---[ ]---(S)---(R)-
| %MX0  %MX1        %MX1
+--[ ]---[/]---------(S)-
| %MX0  %MX1  %MX0  %MX1
+--[ ]---[ ]---(R)---(R)-
|
">two bit counter</option>
</select>

</body>
